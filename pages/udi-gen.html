<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GS1 DataMatrix Generator</title>
    <!-- 1. Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load the client-side bwip-js library -->
    <script src="https://cdn.jsdelivr.net/npm/bwip-js"></script>
    
    <!-- 3. Load Inter font (Removed to match reference file) -->
    
    <style>
        /* Hide the canvas visually but keep it accessible for drawing */
        #barcodeCanvas {
            position: absolute;
            left: -9999px;
            top: -9999px;
        }

        /* NEW: Fade animations from reference file */
        .fade-in {
          opacity: 0;
          transform: translateY(-10px);
          animation: fadeIn 0.4s forwards;
        }
        @keyframes fadeIn {
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        .fade-out {
          opacity: 1;
          transform: translateY(0);
          animation: fadeOut 0.4s forwards;
        }
        @keyframes fadeOut {
          to {
            opacity: 0;
            transform: translateY(-10px);
          }
        }
    </style>
</head>
<body class="h-full flex items-center justify-center p-6 bg-gray-100 font-sans">

    <!-- UPDATED: Styling for main card -->
    <div class="w-full max-w-lg bg-white rounded-xl shadow-2xl p-8 md:p-10 relative">
        
        <!-- Header -->
        <!-- UPDATED: Styling for header -->
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">
            GS1 DataMatrix Generator
        </h1>
        <p class="text-gray-600 mb-6 text-center"> <!-- mb-8 changed to mb-6 -->
            Enter the UDI components to generate a barcode.
        </p>

        <!-- Barcode Form -->
        <form id="barcodeForm" class="space-y-6">
            
            <!-- UDI Component Inputs -->
            <div class="grid grid-cols-2 gap-4">
                <!-- GTIN -->
                <div>
                    <!-- UPDATED: Label styling -->
                    <label for="gtinInput" class="block text-sm font-semibold text-gray-700 mb-1.5">
                        (01) GTIN
                    </label>
                    <!-- UPDATED: Input styling -->
                    <input type="text" id="gtinInput"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                           value="06973864851474"
                           placeholder="e.g., 06973864851474">
                </div>

                <!-- LOT Number -->
                <div>
                    <!-- UPDATED: Label styling -->
                    <label for="lotInput" class="block text-sm font-semibold text-gray-700 mb-1.5">
                        (10) LOT Number
                    </label>
                    <!-- UPDATED: Input styling -->
                    <input type="text" id="lotInput"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                           value="1434001"
                           placeholder="e.g., 1434001">
                </div>

                <!-- Manufacturing Date -->
                <div>
                    <!-- UPDATED: Label styling -->
                    <label for="mfgDateInput" class="block text-sm font-semibold text-gray-700 mb-1.5">
                        (11) Manufacturing Date
                    </label>
                    <!-- UPDATED: Input styling -->
                    <input type="text" id="mfgDateInput"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                           value="251201"
                           placeholder="YYMMDD">
                </div>

                <!-- Expiry Date -->
                <div>
                    <!-- UPDATED: Label styling -->
                    <label for="expDateInput" class="block text-sm font-semibold text-gray-700 mb-1.5">
                        (17) Expiry Date
                    </label>
                    <!-- UPDATED: Input styling -->
                    <input type="text" id="expDateInput"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                           value="301101"
                           placeholder="YYMMDD">
                </div>
            </div>
            
            <!-- Generate Button -->
            <!-- UPDATED: Button styling -->
            <button type="submit"
                    class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 transition">
                Generate Barcode
            </button>
        </form>

        <!-- Download Button (hidden by default) -->
        <!-- UPDATED: Button styling -->
        <a id="downloadBtn"
           class="hidden w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500 transition text-center mt-4 block">
           Download as PNG
        </a>
        
        <!-- Error Message Area (hidden by default) -->
        <div id="errorMessage"
             class="hidden mt-4 text-red-700 bg-red-100 border border-red-400 p-4 rounded-lg">
        </div>
        
        <!-- Preview Image -->
        <div id="previewContainer" class="mt-6 border border-gray-200 rounded-lg p-4 justify-center items-center bg-gray-50 min-h-[150px] hidden">
            <img id="previewImage" alt="Barcode Preview" class="mx-auto block max-w-full">
        </div>

    </div>

    <!-- 
      Canvas Element:
...
    -->
    <canvas id="barcodeCanvas"></canvas>

    <!-- NEW: Toast Notification (from reference file) -->
    <div id="toast" class="hidden absolute top-4 left-1/2 -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg font-medium"></div>


    <script>
        // NEW: showToast function from reference file
        function showToast(message, color = "green") {
          const toast = document.getElementById("toast");
          toast.textContent = message;
          // Note: We need to be careful with Tailwind's JIT compiler.
          // For colors, we'll just handle green and red explicitly.
          let colorClasses = 'bg-green-600';
          if (color === 'red') {
              colorClasses = 'bg-red-600';
          }
          
          toast.className = `absolute top-4 left-1/2 -translate-x-1/2 ${colorClasses} text-white px-6 py-3 rounded-lg shadow-lg font-medium fade-in`;
          toast.classList.remove("hidden");

          // Hide after 3 seconds with fade-out
          setTimeout(() => {
            toast.classList.replace("fade-in", "fade-out");
            setTimeout(() => {
              toast.classList.add("hidden");
            }, 400);
          }, 3000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Get all the elements we need
            const form = document.getElementById('barcodeForm');
            // Get the new input fields
            const gtinInput = document.getElementById('gtinInput');
            const mfgDateInput = document.getElementById('mfgDateInput');
            const expDateInput = document.getElementById('expDateInput');
            const lotInput = document.getElementById('lotInput');
            
            const downloadBtn = document.getElementById('downloadBtn');
            const errorMessage = document.getElementById('errorMessage');
            const previewContainer = document.getElementById('previewContainer');
            const previewImage = document.getElementById('previewImage');
            const canvas = document.getElementById('barcodeCanvas');
            
            // REMOVED: Old toast elements
            // const toastNotification = document.getElementById('toastNotification');
            // let toastTimer;

            // UPDATED: Listen for download click and show new toast
            downloadBtn.addEventListener('click', () => {
                showToast("✅ Download started!");
            });

            // Listen for the form submission
            form.addEventListener('submit', (e) => {
                e.preventDefault(); // Stop the form from reloading the page
                
                // Hide old results and errors
                downloadBtn.classList.add('hidden');
                errorMessage.classList.add('hidden'); // Still use this for inline validation
                previewContainer.classList.add('hidden');
                errorMessage.textContent = '';

                // Get values from the form and remove spaces as requested
                const gtin = gtinInput.value.replaceAll(" ", "");
                const mfgDate = mfgDateInput.value.replaceAll(" ", "");
                const expDate = expDateInput.value.replaceAll(" ", "");
                const lot = lotInput.value.replaceAll(" ", "");
                
                // Set fixed scale and padding
                const scale = 6;
                const padding = 2;
                
                // NEW: Validate that all fields are filled
                if (!gtin || !mfgDate || !expDate || !lot) {
                    // We still use the inline error message for form validation
                    // as it's part of the form, not a success/fail action.
                    errorMessage.textContent = 'Please fill out all four fields (GTIN, Mfg. Date, Exp. Date, and LOT Number).';
                    errorMessage.classList.remove('hidden');
                    return;
                }

                // NEW: Construct the UDI string based on the formula
                // FIX: Added parentheses around AIs (01, 11, 17, 10) for GS1 parsing.
                const udiText = `(01)${gtin}(11)${mfgDate}(17)${expDate}(10)${lot}`;

                // --- Generate the Barcode ---
                try {
                    // Use bwipjs.toCanvas to draw the barcode
                    // We pass the canvas element directly
                    bwipjs.toCanvas(canvas, {
                        bcid: 'gs1datamatrix', // GS1 DataMatrix symbology
                        text: udiText,        // The NEWLY CONSTRUCTED UDI string
                        scale: scale,         // Scale factor
                        padding: padding,     // Padding in pixels
                        backgroundcolor: 'FFFFFF',
                        includetext: false,   // Don't include human-readable text
                        parse: true           // CRITICAL: Parse for GS1 application identifiers
                    });

                    // --- Success ---
                    
                    // Convert the canvas drawing to a PNG data URL
                    const pngUrl = canvas.toDataURL('image/png');

                    // Set the download button's href and filename
                    downloadBtn.href = pngUrl;
                    downloadBtn.download = `gs1datamatrix_${Date.now()}.png`;
                    
                    // Show the download button
                    downloadBtn.classList.remove('hidden');

                    // Show the preview image
                    previewImage.src = pngUrl;
                    previewContainer.classList.remove('hidden');

                } catch (err) {
                    // --- Error ---
                    console.error(err);
                    let userError = err.message || 'An unknown error occurred.';
                    
                    // Provide a more user-friendly error
                    if (userError.includes('is not a valid GS1 DataMatrix')) {
                        userError = 'Invalid GS1 DataMatrix string. Please check your input.';
                    } else if (userError.includes('bwipp.gs1datatrix')) {
                         userError = 'The input string is not a valid GS1 DataMatrix. Please check the format.';
                    } else if (userError.includes('must be 6 digits')) {
                        userError = 'A date is formatted incorrectly. Please use the YYMMDD format for dates.';
                    }
                    
                    // UPDATED: Use the new toast for generation errors
                    showToast(`❌ Error: ${userError}`, 'red');
                }
            });
        });
    </script>

</body>
</html>
